<script type="text/discourse-plugin" version="0.8.7">
// const { ajax } = require("discourse/lib/ajax"); // Moved inside onPageChange
// const { schedule } = require("@ember/runloop"); // No longer needed

console.log("[Discord Style Chat] Theme component loaded!");

api.onPageChange(() => {
  console.log("[Discord Style Chat] Page changed, initializing...");
  
  const { ajax } = require("discourse/lib/ajax");
  
  // Settings with defaults
  const getSetting = (name, defaultValue) => {
    try {
      return settings[name] !== undefined ? settings[name] : defaultValue;
    } catch (e) {
      return defaultValue;
    }
  };

  const sidebarEnabled = getSetting('enable_online_sidebar', true);
  const sidebarWidth = getSetting('sidebar_width', 240);
  const refreshInterval = getSetting('user_refresh_interval', 30000);

  console.log("[Discord Style Chat] Settings:", {
    sidebarEnabled,
    sidebarWidth,
    refreshInterval
  });

  if (!sidebarEnabled) {
    console.log("[Discord Style Chat] Sidebar disabled in settings");
    return;
  }

  // Set CSS variable
  document.documentElement.style.setProperty('--sidebar-width', `${sidebarWidth}px`);
  document.body.classList.add("enable-online-sidebar");
  
  let fetchTimer = null;

  function createSidebar() {
    console.log("[Discord Style Chat] Creating sidebar...");
    
    // Remove existing sidebar if present
    const existing = document.getElementById('discord-online-users-sidebar');
    if (existing) {
      console.log("[Discord Style Chat] Removing existing sidebar");
      existing.remove();
    }

    const sidebar = document.createElement('div');
    sidebar.id = 'discord-online-users-sidebar';
    sidebar.className = 'discord-sidebar';
    
    // Add inline styles to ensure visibility for debugging
    sidebar.style.cssText = `
      position: fixed !important;
      top: 60px !important;
      right: 0 !important;
      width: ${sidebarWidth}px !important;
      height: calc(100vh - 60px) !important;
      background-color: #2f3136 !important;
      border-left: 1px solid #202225 !important;
      z-index: 9999 !important;
      overflow-y: auto !important;
      display: block !important;
      visibility: visible !important;
    `;
    
    sidebar.innerHTML = `
      <div class="discord-sidebar-header" style="padding: 16px; border-bottom: 1px solid #202225;">
        <h3 style="color: #8e9297; font-size: 12px; font-weight: 600; margin: 0;">
          Online — <span class="online-count">0</span>
        </h3>
      </div>
      <div class="discord-sidebar-users loading" style="padding: 8px; color: #dcddde;"></div>
    `;

    document.body.appendChild(sidebar);
    console.log("[Discord Style Chat] Sidebar appended to body with inline styles");
    
    // Verify it was added
    const check = document.getElementById('discord-online-users-sidebar');
    if (check) {
      console.log("[Discord Style Chat] ✓ Sidebar successfully added to DOM");
      console.log("[Discord Style Chat] Sidebar position:", {
        top: sidebar.style.top,
        right: sidebar.style.right,
        width: sidebar.style.width,
        zIndex: sidebar.style.zIndex
      });
    } else {
      console.error("[Discord Style Chat] ✗ Failed to add sidebar to DOM");
    }

    // Fetch users
    fetchOnlineUsers();
    
    // Set up refresh
    if (fetchTimer) clearInterval(fetchTimer);
    fetchTimer = setInterval(fetchOnlineUsers, refreshInterval);
  }

  function fetchOnlineUsers() {
    console.log("[Discord Style Chat] Fetching users...");
    const usersContainer = document.querySelector('.discord-sidebar-users');
    if (!usersContainer) {
      console.warn("[Discord Style Chat] Users container not found");
      return;
    }

    ajax("/directory_items.json", {
      data: {
        period: "all",
        order: "likes_received",
        asc: false,
        limit: 50
      }
    })
    .then(data => {
      console.log("[Discord Style Chat] Data received:", data);
      const users = data.directory_items || [];
      console.log(`[Discord Style Chat] Found ${users.length} users`);
      updateUsersList(users.slice(0, 20));
    })
    .catch(error => {
      console.error("[Discord Style Chat] Error:", error);
      usersContainer.classList.remove('loading');
      usersContainer.classList.add('empty');
      usersContainer.innerHTML = '<div style="padding: 16px; text-align: center; color: #8e9297;">Failed to load users</div>';
    });
  }

  function updateUsersList(users) {
    console.log(`[Discord Style Chat] Updating list with ${users.length} users`);
    const usersContainer = document.querySelector('.discord-sidebar-users');
    const countElement = document.querySelector('.online-count');

    if (!usersContainer || !countElement) {
      console.warn("[Discord Style Chat] Elements not found");
      return;
    }

    usersContainer.classList.remove('loading', 'empty');

    if (users.length === 0) {
      usersContainer.classList.add('empty');
      countElement.textContent = '0';
      usersContainer.innerHTML = '<div style="padding: 16px; text-align: center; color: #8e9297;">No users found</div>';
      return;
    }

    countElement.textContent = users.length;

    usersContainer.innerHTML = users.map(item => {
      const user = item.user;
      let avatarUrl = user.avatar_template;
      
      if (avatarUrl.startsWith('/')) {
        avatarUrl = window.location.origin + avatarUrl;
      }
      avatarUrl = avatarUrl.replace('{size}', '96');

      return `
        <div class="discord-user-item" data-username="${user.username}" style="display: flex; align-items: center; padding: 8px; margin: 2px 0; border-radius: 4px; cursor: pointer;">
          <div class="user-avatar" style="width: 32px; height: 32px; margin-right: 12px; position: relative;">
            <img src="${avatarUrl}" alt="${user.username}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">
            <div class="status-indicator" style="position: absolute; bottom: -2px; right: -2px; width: 12px; height: 12px; background-color: #43b581; border: 3px solid #2f3136; border-radius: 50%;"></div>
          </div>
          <div class="user-info" style="flex: 1; min-width: 0;">
            <div class="username" style="color: #dcddde; font-size: 14px; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${user.username}</div>
            ${user.name ? `<div class="user-status" style="color: #8e9297; font-size: 12px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${user.name}</div>` : ''}
          </div>
        </div>
      `;
    }).join('');

    console.log("[Discord Style Chat] Users list updated");

    // Add click handlers and hover effects
    usersContainer.querySelectorAll('.discord-user-item').forEach(item => {
      item.addEventListener('mouseenter', () => {
        item.style.backgroundColor = '#3c3f45';
      });
      item.addEventListener('mouseleave', () => {
        item.style.backgroundColor = 'transparent';
      });
      item.addEventListener('click', () => {
        const username = item.dataset.username;
        console.log(`[Discord Style Chat] Clicked user: ${username}`);
        window.location.href = `/u/${username}`;
      });
    });
  }

  // Create sidebar immediately
  createSidebar();
});
</script>