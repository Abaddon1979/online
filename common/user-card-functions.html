<script type="text/discourse-plugin" version="0.8.7">
// User Card Functions
api.modifyClass("component:user-card-contents", {
  pluginId: "discord-style-chat",
  
  didInsertElement() {
    this._super(...arguments);
    
    const { ajax } = require("discourse/lib/ajax");
    
    window.showUserCard = function(username, event) {
      // Close any existing cards
      document.querySelectorAll('.discord-user-card-backdrop, .discord-user-card').forEach(el => el.remove());
      
      const backdrop = document.createElement('div');
      backdrop.className = 'discord-user-card-backdrop';
      backdrop.onclick = () => document.querySelectorAll('.discord-user-card-backdrop, .discord-user-card').forEach(el => el.remove());
      
      const card = document.createElement('div');
      card.className = 'discord-user-card';
      
      const clickX = (event && typeof event.clientX === "number") ? event.clientX : window.innerWidth / 2;
      const clickY = (event && typeof event.clientY === "number") ? event.clientY : window.innerHeight / 2;
      const cardWidth = 700;
      const cardHeight = 320;
      
      let left = clickX + 10;
      if (left + cardWidth > window.innerWidth) left = clickX - cardWidth - 10;
      
      let top = clickY + 10;
      if (top + cardHeight > window.innerHeight) top = Math.max(10, clickY - cardHeight - 10);
      
      card.style.left = left + 'px';
      card.style.top = top + 'px';
      card.style.position = 'fixed';
      
      card.innerHTML = '<button class="user-card-close" type="button">√ó</button><div class="user-card-left"><div class="user-card-loading"><div class="spinner"></div><span>Loading...</span></div></div><div class="user-card-right"></div>';
      
      document.body.appendChild(backdrop);
      document.body.appendChild(card);
      
      const closeBtn = card.querySelector('.user-card-close');
      if (closeBtn) {
        closeBtn.onclick = function(e) {
          if (e && typeof e.stopPropagation === "function") e.stopPropagation();
          document.querySelectorAll('.discord-user-card-backdrop, .discord-user-card').forEach(el => el.remove());
        };
      }
      
      ajax("/u/" + username + ".json").then(data => {
        const user = data.user;
        const avatar = (user.avatar_template.startsWith('/') ? window.location.origin : '') + user.avatar_template.replace('{size}', '256');
        
        const leftSection = card.querySelector('.user-card-left');
        const rightSection = card.querySelector('.user-card-right');
        if (!leftSection || !rightSection) return;
        
        const savedBg = localStorage.getItem('user_card_bg_' + username);
        if (savedBg) {
          card.style.setProperty('--user-card-bg', 'url(' + savedBg + ')');
          card.setAttribute('data-bg-url', savedBg);
        }
        
        const rolesHTML = user.groups && user.groups.length > 0 ? '<div class="roles-section"><div class="section-title">Roles</div><div class="roles-list">' + user.groups.slice(0, 8).map(g => '<a href="/g/' + g.name + '" class="role-chip">' + (g.display_name || g.name) + '</a>').join('') + '</div></div>' : '';
        
        const badgesHTML = user.featured_user_badge_ids && user.featured_user_badge_ids.length > 0 ? '<div class="badges-section"><div class="section-title">Badges</div><div class="badges-list">' + user.featured_user_badge_ids.slice(0, 6).map(() => '<div class="badge-chip"><span>üèÖ</span><span>Badge</span></div>').join('') + '</div></div>' : '';
        
        const editIconSVG = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>';
        
        leftSection.innerHTML = '<div class="user-card-avatar"><img src="' + avatar + '"><div class="status-badge"></div><button class="edit-background-btn" title="Change Background">' + editIconSVG + '</button></div><div class="user-info"><h2 class="display-name">' + (user.name || user.username) + '</h2><p class="username">@' + user.username + '</p>' + (user.title ? '<span class="title-badge">' + user.title + '</span>' : '') + '</div><div class="posts-stat"><span class="stat-value">' + (user.post_count || 0) + '</span><span class="stat-label">Posts</span></div>';
        
        rightSection.innerHTML = '<div class="status-box"><div class="status-label">Status</div><div class="status-text"><span class="status-indicator"></span><span>Online</span></div></div>' + rolesHTML + badgesHTML + '<div class="user-actions"><a href="/new-message?username=' + user.username + '&type=chat" class="btn btn-primary">üí¨ Chat</a><a href="/new-message?username=' + user.username + '" class="btn btn-secondary">‚úâÔ∏è Message</a><a href="/u/' + user.username + '" class="btn btn-secondary">üë§ Profile</a></div>';
        
        const editBtn = card.querySelector('.edit-background-btn');
        if (editBtn) {
          editBtn.onclick = function(e) {
            e.stopPropagation();
            openTenorPicker(username, card);
          };
        }
        
        if (closeBtn) {
          closeBtn.onclick = function(e) {
            if (e && typeof e.stopPropagation === "function") e.stopPropagation();
            document.querySelectorAll('.discord-user-card-backdrop, .discord-user-card').forEach(el => el.remove());
          };
        }
      });
    };
    
    window.openTenorPicker = function(username, cardElement) {
      const modal = document.createElement('div');
      modal.className = 'tenor-picker-modal';
      modal.innerHTML = '<div class="tenor-header"><h3>Select Animated Background</h3><button class="tenor-close">√ó</button></div><div class="tenor-search"><input type="text" placeholder="Search for GIFs..." class="tenor-search-input"></div><div class="tenor-results"></div>';
      
      document.body.appendChild(modal);
      
      const closeBtn = modal.querySelector('.tenor-close');
      const searchInput = modal.querySelector('.tenor-search-input');
      const resultsDiv = modal.querySelector('.tenor-results');
      
      closeBtn.onclick = () => modal.remove();
      
      const TENOR_API_KEY = 'AIzaSyAyimkuYQYF_FXVALexPuGQctUWRURdCYQ';
      
      function searchTenor(query) {
        const searchQuery = query || 'anime aesthetic';
        const limit = 30;
        const url = `https://tenor.googleapis.com/v2/search?q=${encodeURIComponent(searchQuery)}&key=${TENOR_API_KEY}&limit=${limit}&media_filter=gif,webp`;
        
        fetch(url).then(response => response.json()).then(data => {
          resultsDiv.innerHTML = '';
          if (data.results) {
            data.results.forEach(gif => {
              const img = document.createElement('img');
              img.src = gif.media_formats.tinygif?.url || gif.media_formats.gif.url;
              const fullUrl = gif.media_formats.webp?.url || gif.media_formats.gif?.url;
              img.dataset.fullUrl = fullUrl;
              img.onclick = () => {
                const bgUrl = img.dataset.fullUrl;
                cardElement.style.setProperty('--user-card-bg', 'url(' + bgUrl + ')');
                cardElement.setAttribute('data-bg-url', bgUrl);
                localStorage.setItem('user_card_bg_' + username, bgUrl);
                modal.remove();
              };
              resultsDiv.appendChild(img);
            });
          }
        }).catch(err => {
          console.error('Tenor search error:', err);
          resultsDiv.innerHTML = '<p style="color:#dcddde;text-align:center;padding:20px;">Failed to load GIFs.</p>';
        });
      }
      
      searchTenor('');
      
      let searchTimeout;
      searchInput.addEventListener('input', (e) => {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => searchTenor(e.target.value), 500);
      });
    };
  }
});
</script>