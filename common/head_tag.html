<script type="text/discourse-plugin" version="0.8.7">
console.log("[Discord Style Chat] Plugin loaded");

// Move variables outside to persist across page changes
let fetchTimer = null;
let onlineUsernames = new Set();

api.onPageChange(() => {
  const { ajax } = require("discourse/lib/ajax");
  const sidebarEnabled = (settings.enable_online_sidebar !== false);
  const sidebarWidth = settings.sidebar_width || 240;
  const refreshInterval = settings.user_refresh_interval || 30000;

  if (!sidebarEnabled) return;
  
  // Only show sidebar on desktop (screens wider than 1024px) and not on mobile devices
  if (window.innerWidth <= 1024 || /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
    return;
  }
  
  // Check if we're on a chat page
  const isChatPage = window.location.pathname.includes('/chat') || document.querySelector('.full-page-chat, .chat-drawer');
  
  // If not on chat page, remove sidebar and clean up
  if (!isChatPage) {
    console.log('[Discord Chat] Not on chat page, cleaning up sidebar');
    const existing = document.getElementById('discord-online-users-sidebar');
    if (existing) {
      existing.remove();
      console.log('[Discord Chat] Sidebar removed');
    }
    document.body.classList.remove("enable-online-sidebar");
    document.documentElement.style.removeProperty('--sidebar-width');
    if (fetchTimer) {
      clearInterval(fetchTimer);
      fetchTimer = null;
      console.log('[Discord Chat] Timer cleared');
    }
    return;
  }

  console.log('[Discord Chat] On chat page, setting up sidebar');

  //We're on a chat page, set up the sidebar
  document.documentElement.style.setProperty('--sidebar-width', sidebarWidth + 'px');
  document.body.classList.add("enable-online-sidebar");

  function showUserCard(username, event) {
    closeUserCard();

    const backdrop = document.createElement('div');
    backdrop.className = 'discord-user-card-backdrop';
    backdrop.onclick = closeUserCard;

    const card = document.createElement('div');
    card.className = 'discord-user-card';

    const clickX = (event && typeof event.clientX === "number") ? event.clientX : window.innerWidth / 2;
    const clickY = (event && typeof event.clientY === "number") ? event.clientY : window.innerHeight / 2;
    const cardWidth = 600;
    const cardHeight = 400;

    let left = clickX + 10;
    if (left + cardWidth > window.innerWidth) {
      left = clickX - cardWidth - 10;
    }

    let top = clickY + 10;
    if (top + cardHeight > window.innerHeight) {
      top = Math.max(10, clickY - cardHeight - 10);
    }

    card.style.left = left + 'px';
    card.style.top = top + 'px';
    card.style.position = 'fixed';

    // Initial loading state with close button
    card.innerHTML =
      '<div class="user-card-banner"></div>' +
      '<div class="user-card-body">' +
        '<button class="user-card-close" type="button">√ó</button>' +
        '<div class="user-card-loading">' +
          '<div class="spinner"></div>' +
          '<span>Loading...</span>' +
        '</div>' +
      '</div>';

    document.body.appendChild(backdrop);
    document.body.appendChild(card);

    function wireClose() {
      const closeBtn = card.querySelector('.user-card-close');
      if (closeBtn) {
        closeBtn.onclick = function (e) {
          if (e && typeof e.stopPropagation === "function") {
            e.stopPropagation();
          }
          closeUserCard();
        };
      }
    }

    wireClose();

    ajax("/u/" + username + ".json").then(data => {
      const user = data.user;
      const avatar =
        (user.avatar_template.startsWith('/') ? window.location.origin : '') +
        user.avatar_template.replace('{size}', '256');

      const body = card.querySelector('.user-card-body');
      const banner = card.querySelector('.user-card-banner');
      if (!body || !banner) {
        return;
      }

      // Load custom background if saved
      const savedBg = localStorage.getItem('user_card_bg_' + user.username);
      if (savedBg) {
        banner.style.backgroundImage = 'url(' + savedBg + ')';
      }

      // Get user's actual badges
      const badgesHTML = user.featured_user_badge_ids && user.featured_user_badge_ids.length > 0
        ? '<div class="badges-section">' +
            '<div class="section-title">Badges</div>' +
            '<div class="badges-list">' +
              user.featured_user_badge_ids.slice(0, 5).map(() => 
                '<div class="badge-chip">' +
                  '<span>üèÖ</span>' +
                  '<span>Badge</span>' +
                '</div>'
              ).join('') +
            '</div>' +
          '</div>'
        : '';

      // Groups as chips
      const groupsHTML = user.groups && user.groups.length > 0
        ? '<div class="groups-section">' +
            '<div class="section-title">Roles</div>' +
            '<div class="groups-list">' +
              user.groups.slice(0, 6).map(g =>
                '<a href="/g/' + g.name + '" class="group-chip">' +
                  (g.display_name || g.name) +
                '</a>'
              ).join('') +
            '</div>' +
          '</div>'
        : '';

      // Final content - modern layout with only Posts stat
      body.innerHTML =
        '<button class="user-card-close" type="button">√ó</button>' +
        '<button class="edit-background-btn" title="Change Background">üé®</button>' +
        '<div class="user-card-avatar">' +
          '<img src="' + avatar + '">' +
          '<div class="status-badge"></div>' +
        '</div>' +
        '<div class="user-info">' +
          '<h2 class="display-name">' + (user.name || user.username) + '</h2>' +
          '<p class="username">@' + user.username + '</p>' +
          (user.title
            ? '<span class="title-badge">' + user.title + '</span>'
            : '') +
        '</div>' +
        '<div class="stats-section">' +
          '<div class="stat-box">' +
            '<span class="stat-value">' + (user.post_count || 0) + '</span>' +
            '<span class="stat-label">Posts</span>' +
          '</div>' +
        '</div>' +
        badgesHTML +
        groupsHTML +
        '<div class="user-actions">' +
          '<a href="/new-message?username=' + user.username + '&type=chat" class="btn btn-primary">üí¨ Chat</a>' +
          '<a href="/new-message?username=' + user.username + '" class="btn btn-secondary">‚úâÔ∏è Message</a>' +
          '<a href="/u/' + user.username + '" class="btn btn-secondary">üë§ Profile</a>' +
        '</div>';

      // Add edit background button functionality
      const editBtn = body.querySelector('.edit-background-btn');
      if (editBtn) {
        editBtn.onclick = function(e) {
          e.stopPropagation();
          openTenorPicker(username, banner);
        };
      }

      // Move edit button to banner
      const bannerEl = card.querySelector('.user-card-banner');
      if (bannerEl && editBtn) {
        bannerEl.appendChild(editBtn);
      }

      wireClose();
    });
  }

  function openTenorPicker(username, bannerElement) {
    // Create Tenor picker modal
    const modal = document.createElement('div');
    modal.className = 'tenor-picker-modal';
    modal.innerHTML =
      '<div class="tenor-header">' +
        '<h3>Select Background</h3>' +
        '<button class="tenor-close">√ó</button>' +
      '</div>' +
      '<div class="tenor-search">' +
        '<input type="text" placeholder="Search for GIFs..." class="tenor-search-input">' +
      '</div>' +
      '<div class="tenor-results"></div>';

    document.body.appendChild(modal);

    const closeBtn = modal.querySelector('.tenor-close');
    const searchInput = modal.querySelector('.tenor-search-input');
    const resultsDiv = modal.querySelector('.tenor-results');

    closeBtn.onclick = () => modal.remove();

    // Tenor API key - you'll need to get your own from https://tenor.com/developer/keyregistration
    const TENOR_API_KEY = 'AIzaSyAyimkuYQYF_FXVALexPuGQctUWRURdCYQ'; // Replace with your key
    
    function searchTenor(query) {
      const searchQuery = query || 'anime scenery';
      const limit = 20;
      const url = `https://tenor.googleapis.com/v2/search?q=${encodeURIComponent(searchQuery)}&key=${TENOR_API_KEY}&limit=${limit}&media_filter=minimal`;

      fetch(url)
        .then(response => response.json())
        .then(data => {
          resultsDiv.innerHTML = '';
          if (data.results) {
            data.results.forEach(gif => {
              const img = document.createElement('img');
              // Use tinygif for preview, but store the full webp URL
              img.src = gif.media_formats.tinygif.url;
              img.dataset.fullUrl = gif.media_formats.webp?.url || gif.media_formats.gif.url;
              img.onclick = () => {
                const bgUrl = img.dataset.fullUrl;
                bannerElement.style.backgroundImage = 'url(' + bgUrl + ')';
                localStorage.setItem('user_card_bg_' + username, bgUrl);
                modal.remove();
              };
              resultsDiv.appendChild(img);
            });
          }
        })
        .catch(err => {
          console.error('Tenor search error:', err);
          resultsDiv.innerHTML = '<p style="color:#dcddde;text-align:center;padding:20px;">Failed to load GIFs</p>';
        });
    }

    // Initial search
    searchTenor('');

    // Search on input
    let searchTimeout;
    searchInput.addEventListener('input', (e) => {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(() => {
        searchTenor(e.target.value);
      }, 500);
    });
  }

  function closeUserCard() {
    document
      .querySelectorAll('.discord-user-card-backdrop, .discord-user-card')
      .forEach(el => el.remove());
  }

  function updateOnlineStatus() {
    createSidebar();
  }

  function createSidebar() {
    const existing = document.getElementById('discord-online-users-sidebar');
    if (existing) existing.remove();
    
    const sidebar = document.createElement('div');
    sidebar.id = 'discord-online-users-sidebar';
    sidebar.className = 'discord-sidebar';
    sidebar.style.cssText = 'position:fixed!important;top:60px!important;right:0!important;width:' + sidebarWidth + 'px!important;height:calc(100vh - 60px)!important;background:#19191d!important;border-left:1px solid #202225!important;z-index:999!important;overflow-y:auto!important;display:block!important;';
    sidebar.innerHTML = '<div class="discord-sidebar-header" style="padding:16px;border-bottom:1px solid #202225;"><h3 style="color:#8e9297;font-size:12px;font-weight:600;margin:0;">Users ‚Äî <span class="online-count">0</span></h3></div><div class="discord-sidebar-users loading" style="padding:8px;"></div>';
    document.body.appendChild(sidebar);

    // Fetch online users from sideonline.json - this is the only source
    ajax("/sideonline.json").then(data => {
      const allUsers = data.users || [];
      console.log('[Discord Chat] Loaded ' + allUsers.length + ' online users from sideonline.json');
      
      onlineUsernames = new Set(allUsers.map(u => u.username));
      
      const container = document.querySelector('.discord-sidebar-users');
      const count = document.querySelector('.online-count');
      if (!container) return;
      container.classList.remove('loading');
      
      // Categorize users - all are online
      const admins = [];
      const moderators = [];
      const onlineTL4 = [];
      const onlineTL3 = [];
      const onlineTL2 = [];
      const onlineTL1 = [];
      const onlineTL0 = [];
      
      allUsers.forEach(user => {
        if (user.admin) {
          admins.push(user);
        } else if (user.moderator) {
          moderators.push(user);
        } else {
          const tl = user.trust_level || 0;
          if (tl === 4) onlineTL4.push(user);
          else if (tl === 3) onlineTL3.push(user);
          else if (tl === 2) onlineTL2.push(user);
          else if (tl === 1) onlineTL1.push(user);
          else onlineTL0.push(user);
        }
      });
      
      console.log('[Discord Chat] Categorized: Admins=' + admins.length + ', Mods=' + moderators.length + ', TL4=' + onlineTL4.length + ', TL3=' + onlineTL3.length + ', TL2=' + onlineTL2.length + ', TL1=' + onlineTL1.length + ', TL0=' + onlineTL0.length);
      
      let html = '';
      
      // Admins - only if online
      if (admins.length > 0) {
        html += '<div class="role-group"><div class="role-header" style="color:#e74c3c;font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;padding:12px 8px 4px 8px;">Administrators ‚Äî ' + admins.length + '</div>';
        admins.forEach(u => html += renderUser(u));
        html += '</div>';
      }
      
      // Moderators - only if online
      if (moderators.length > 0) {
        html += '<div class="role-group"><div class="role-header" style="color:#f39c12;font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;padding:12px 8px 4px 8px;">Moderators ‚Äî ' + moderators.length + '</div>';
        moderators.forEach(u => html += renderUser(u));
        html += '</div>';
      }
      
      // Trust levels - only online users
      if (onlineTL4.length > 0) {
        html += '<div class="role-group"><div class="role-header" style="color:#9b59b6;font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;padding:12px 8px 4px 8px;">Trust Level 4 ‚Äî ' + onlineTL4.length + '</div>';
        onlineTL4.forEach(u => html += renderUser(u));
        html += '</div>';
      }
      
      if (onlineTL3.length > 0) {
        html += '<div class="role-group"><div class="role-header" style="color:#1abc9c;font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;padding:12px 8px 4px 8px;">Trust Level 3 ‚Äî ' + onlineTL3.length + '</div>';
        onlineTL3.forEach(u => html += renderUser(u));
        html += '</div>';
      }
      
      if (onlineTL2.length > 0) {
        html += '<div class="role-group"><div class="role-header" style="color:#95a5a6;font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;padding:12px 8px 4px 8px;">Trust Level 2 ‚Äî ' + onlineTL2.length + '</div>';
        onlineTL2.forEach(u => html += renderUser(u));
        html += '</div>';
      }
      
      if (onlineTL1.length > 0) {
        html += '<div class="role-group"><div class="role-header" style="color:#7f8c8d;font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;padding:12px 8px 4px 8px;">Trust Level 1 ‚Äî ' + onlineTL1.length + '</div>';
        onlineTL1.forEach(u => html += renderUser(u));
        html += '</div>';
      }
      
      if (onlineTL0.length > 0) {
        html += '<div class="role-group"><div class="role-header" style="color:#5f6c6d;font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;padding:12px 8px 4px 8px;">Trust Level 0 ‚Äî ' + onlineTL0.length + '</div>';
        onlineTL0.forEach(u => html += renderUser(u));
        html += '</div>';
      }
      
      container.innerHTML = html;
      container.querySelectorAll('.discord-user-item').forEach(item => {
        item.onmouseenter = () => item.style.backgroundColor = '#3c3f45';
        item.onmouseleave = () => item.style.backgroundColor = 'transparent';
        item.onclick = (e) => { e.preventDefault(); e.stopPropagation(); showUserCard(item.dataset.username, e); };
      });
      
      count.textContent = allUsers.length;
    }).catch(err => {
      console.error('[Discord Chat] Failed to load users from sideonline.json:', err);
    });
  }

  function renderUser(user) {
    const avatar = (user.avatar_template.startsWith('/') ? window.location.origin : '') + user.avatar_template.replace('{size}', '96');
    const statusColor = '#43b581'; // Green - all users shown are online
    
    return '<div class="discord-user-item online" data-username="' + user.username + '" style="display:flex;align-items:center;padding:8px;margin:2px 0;border-radius:4px;cursor:pointer;"><div style="width:32px;height:32px;margin-right:12px;position:relative;"><img src="' + avatar + '" style="width:100%;height:100%;border-radius:50%;"><div class="status-dot" style="position:absolute;bottom:-2px;right:-2px;width:12px;height:12px;background:' + statusColor + ';border:3px solid #19191d;border-radius:50%;"></div></div><div style="flex:1;"><div style="color:#dcddde;font-size:14px;font-weight:500;">' + user.username + '</div></div></div>';
  }

  createSidebar();
  
  if (fetchTimer) clearInterval(fetchTimer);
  fetchTimer = setInterval(updateOnlineStatus, refreshInterval);
});
</script>