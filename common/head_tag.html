<script type="text/discourse-plugin" version="0.8.7">
console.log("[Discord Style Chat] Plugin loaded");

api.onPageChange(() => {
  const { ajax } = require("discourse/lib/ajax");
  const sidebarEnabled = (settings.enable_online_sidebar !== false);
  const sidebarWidth = settings.sidebar_width || 240;
  const refreshInterval = settings.user_refresh_interval || 30000;

  if (!sidebarEnabled) return;

  document.documentElement.style.setProperty('--sidebar-width', sidebarWidth + 'px');
  document.body.classList.add("enable-online-sidebar");
  
  let fetchTimer = null;

  function showUserCard(username, event) {
    closeUserCard();
    const backdrop = document.createElement('div');
    backdrop.className = 'discord-user-card-backdrop';
    backdrop.onclick = closeUserCard;
    const card = document.createElement('div');
    card.className = 'discord-user-card';
    const rect = event.target.closest('.discord-user-item').getBoundingClientRect();
    card.style.top = Math.min(rect.top, window.innerHeight - 500) + 'px';
    card.style.right = (window.innerWidth - rect.left + 10) + 'px';
    card.innerHTML = '<button class="user-card-close" onclick="document.querySelectorAll(\'.discord-user-card-backdrop, .discord-user-card\').forEach(el => el.remove())">√ó</button><div class="user-card-banner"></div><div class="user-card-body"><div class="user-card-loading"><div class="spinner"></div><span>Loading...</span></div></div>';
    
    document.body.appendChild(backdrop);
    document.body.appendChild(card);
    
    ajax("/u/" + username + ".json").then(data => {
      const user = data.user;
      let avatar = user.avatar_template;
      if (avatar.startsWith('/')) avatar = window.location.origin + avatar;
      avatar = avatar.replace('{size}', '256');
      const joined = new Date(user.created_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
      
      const body = card.querySelector('.user-card-body');
      body.innerHTML = '';
      const layout = document.createElement('div');
      layout.className = 'card-layout';
      const left = document.createElement('div');
      left.className = 'left-section';
      left.innerHTML = '<div class="user-card-avatar"><img src="' + avatar + '"><div class="status-badge"></div></div><div class="user-info"><h2 class="display-name">' + (user.name || user.username) + '</h2><p class="username">@' + user.username + '</p>' + (user.title ? '<span class="title-badge">' + user.title + '</span>' : '') + '</div>';
      
      const right = document.createElement('div');
      right.className = 'right-section';
      if (user.bio_cooked) {
        const bio = document.createElement('div');
        bio.className = 'bio';
        bio.innerHTML = user.bio_cooked;
        right.appendChild(bio);
      }
      const meta = document.createElement('div');
      meta.className = 'meta-info';
      meta.innerHTML = '<div class="meta-item">üìÖ Joined ' + joined + '</div>' + (user.location ? '<div class="meta-item">üìç ' + user.location + '</div>' : '');
      if (meta.innerHTML) right.appendChild(meta);
      
      const stats = document.createElement('div');
      stats.className = 'stats-grid';
      stats.innerHTML = '<div class="stat-item"><span class="stat-value">' + (user.post_count || 0) + '</span><span class="stat-label">Posts</span></div><div class="stat-item"><span class="stat-value">' + (user.like_count || 0) + '</span><span class="stat-label">Likes</span></div><div class="stat-item"><span class="stat-value">' + (user.solved_count || 0) + '</span><span class="stat-label">Solutions</span></div>';
      right.appendChild(stats);
      
      if (user.badge_count > 0) {
        const badges = document.createElement('div');
        badges.className = 'badges-section';
        badges.innerHTML = '<div class="badges-title">Badges</div><div class="badges-list"><div class="badge"><span>üèÖ</span><span>' + user.badge_count + ' Badge' + (user.badge_count !== 1 ? 's' : '') + '</span></div></div>';
        right.appendChild(badges);
      }
      const trust = document.createElement('div');
      trust.className = 'trust-level';
      const tl = user.trust_level || 0;
      trust.innerHTML = '<div class="trust-header"><span class="trust-label">Trust Level</span><span class="trust-value">Level ' + tl + '</span></div><div class="trust-bar"><div class="trust-progress" style="width:' + ((tl / 4) * 100) + '%"></div></div>';
      right.appendChild(trust);
      
      if (user.groups && user.groups.length > 0) {
        const groups = document.createElement('div');
        groups.className = 'groups';
        groups.innerHTML = user.groups.map(g => '<a href="/g/' + g.name + '" class="group-chip">' + (g.display_name || g.name) + '</a>').join('');
        right.appendChild(groups);
      }
      
      const actions = document.createElement('div');
      actions.className = 'actions';
      const chatBtn = document.createElement('a');
      chatBtn.className = 'btn btn-primary';
      chatBtn.textContent = 'Chat';
      chatBtn.href = '/new-message?username=' + user.username + '&type=chat';
      const msgBtn = document.createElement('a');
      msgBtn.className = 'btn btn-secondary';
      msgBtn.textContent = 'Message';
      msgBtn.href = '/new-message?username=' + user.username;
      const profBtn = document.createElement('a');
      profBtn.className = 'btn btn-secondary';
      profBtn.textContent = 'Profile';
      profBtn.href = '/u/' + user.username;
      actions.appendChild(chatBtn);
      actions.appendChild(msgBtn);
      actions.appendChild(profBtn);
      right.appendChild(actions);
      
      layout.appendChild(left);
      layout.appendChild(right);
      body.appendChild(layout);
    });
  }

  function closeUserCard() {
    document.querySelectorAll('.discord-user-card-backdrop, .discord-user-card').forEach(el => el.remove());
  }

  function getUserRole(user) {
    if (user.admin) return 'admin';
    if (user.moderator) return 'moderator';
    if (user.groups && user.groups.some(g => g.name === 'staff')) return 'staff';
    return 'tl' + (user.trust_level || 0);
  }

  function createSidebar() {
    const existing = document.getElementById('discord-online-users-sidebar');
    if (existing) existing.remove();
    const sidebar = document.createElement('div');
    sidebar.id = 'discord-online-users-sidebar';
    sidebar.className = 'discord-sidebar';
    sidebar.style.cssText = 'position:fixed!important;top:60px!important;right:0!important;width:' + sidebarWidth + 'px!important;height:calc(100vh - 60px)!important;background:#2f3136!important;border-left:1px solid #202225!important;z-index:9999!important;overflow-y:auto!important;display:block!important;';
    sidebar.innerHTML = '<div class="discord-sidebar-header" style="padding:16px;border-bottom:1px solid #202225;"><h3 style="color:#8e9297;font-size:12px;font-weight:600;margin:0;">Users ‚Äî <span class="online-count">0</span></h3></div><div class="discord-sidebar-users loading" style="padding:8px;"></div>';
    document.body.appendChild(sidebar);

    ajax("/directory_items.json", { data: { period: "all", order: "likes_received", asc: false } }).then(data => {
      const allUsers = data.directory_items || [];
      const container = document.querySelector('.discord-sidebar-users');
      const count = document.querySelector('.online-count');
      if (!container) return;
      container.classList.remove('loading');
      
      const roleGroups = {
        admin: { title: 'Administrators', users: [], color: '#e74c3c' },
        staff: { title: 'Staff', users: [], color: '#3498db' },
        moderator: { title: 'Moderators', users: [], color: '#f39c12' },
        tl4: { title: 'Trust Level 4', users: [], color: '#9b59b6' },
        tl3: { title: 'Trust Level 3', users: [], color: '#1abc9c' },
        tl2: { title: 'Trust Level 2', users: [], color: '#95a5a6' },
        tl1: { title: 'Trust Level 1', users: [], color: '#7f8c8d' },
        tl0: { title: 'Trust Level 0', users: [], color: '#5f6c6d' }
      };
      
      allUsers.forEach(item => {
        const role = getUserRole(item.user);
        if (roleGroups[role]) {
          roleGroups[role].users.push(item.user);
        }
      });
      
      let onlineCount = allUsers.filter(item => {
        const lastSeen = item.user.last_seen_at;
        if (!lastSeen) return false;
        const diff = Date.now() - new Date(lastSeen).getTime();
        return diff < 900000;
      }).length;
      
      count.textContent = onlineCount;
      
      let html = '';
      Object.keys(roleGroups).forEach(roleKey => {
        const group = roleGroups[roleKey];
        if (group.users.length > 0) {
          html += '<div class="role-group"><div class="role-header" style="color:' + group.color + ';font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;padding:12px 8px 4px 8px;">' + group.title + ' ‚Äî ' + group.users.length + '</div>';
          
          group.users.forEach(u => {
            let av = u.avatar_template;
            if (av.startsWith('/')) av = window.location.origin + av;
            av = av.replace('{size}', '96');
            const lastSeen = u.last_seen_at;
            const isOnline = lastSeen && (Date.now() - new Date(lastSeen).getTime()) < 900000;
            const statusColor = isOnline ? '#43b581' : '#747f8d';
            
            html += '<div class="discord-user-item" data-username="' + u.username + '" style="display:flex;align-items:center;padding:8px;margin:2px 0;border-radius:4px;cursor:pointer;' + (isOnline ? 'order:-1;' : '') + '"><div style="width:32px;height:32px;margin-right:12px;position:relative;"><img src="' + av + '" style="width:100%;height:100%;border-radius:50%;"><div style="position:absolute;bottom:-2px;right:-2px;width:12px;height:12px;background:' + statusColor + ';border:3px solid #2f3136;border-radius:50%;"></div></div><div style="flex:1;"><div style="color:#dcddde;font-size:14px;font-weight:500;">' + u.username + '</div></div></div>';
          });
          
          html += '</div>';
        }
      });
      
      container.innerHTML = html;
      container.querySelectorAll('.discord-user-item').forEach(item => {
        item.onmouseenter = () => item.style.backgroundColor = '#3c3f45';
        item.onmouseleave = () => item.style.backgroundColor = 'transparent';
        item.onclick = (e) => { e.preventDefault(); e.stopPropagation(); showUserCard(item.dataset.username, e); };
      });
      if (fetchTimer) clearInterval(fetchTimer);
      fetchTimer = setInterval(() => ajax("/directory_items.json", { data: { period: "all", order: "likes_received", asc: false } }), refreshInterval);
    });
  }

  createSidebar();
});
</script>