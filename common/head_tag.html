<script type="text/discourse-plugin" version="0.8.7">
console.log("[Discord Style Chat] Plugin loaded");

api.onPageChange(() => {
  const { ajax } = require("discourse/lib/ajax");
  const sidebarEnabled = (settings.enable_online_sidebar !== false);
  const sidebarWidth = settings.sidebar_width || 240;
  const refreshInterval = settings.user_refresh_interval || 30000;

  if (!sidebarEnabled) return;
  
  // Only show sidebar on desktop (screens wider than 1024px) and not on mobile devices
  if (window.innerWidth <= 1024 || /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
    return;
  }
  
  // Only show sidebar on chat pages
  const isChatPage = window.location.pathname.includes('/chat') || document.querySelector('.full-page-chat, .chat-drawer');
  if (!isChatPage) return;

  document.documentElement.style.setProperty('--sidebar-width', sidebarWidth + 'px');
  document.body.classList.add("enable-online-sidebar");
  
  let fetchTimer = null;
  let onlineUsernames = new Set();

  function showUserCard(username, event) {
    closeUserCard();
    const backdrop = document.createElement('div');
    backdrop.className = 'discord-user-card-backdrop';
    backdrop.onclick = closeUserCard;
    
    const card = document.createElement('div');
    card.className = 'discord-user-card';
    
    const clickX = event.clientX;
    const clickY = event.clientY;
    const cardWidth = 600;
    const cardHeight = 400;
    
    let left = clickX + 10;
    if (left + cardWidth > window.innerWidth) {
      left = clickX - cardWidth - 10;
    }
    
    let top = clickY + 10;
    if (top + cardHeight > window.innerHeight) {
      top = Math.max(10, clickY - cardHeight - 10);
    }
    
    card.style.left = left + 'px';
    card.style.top = top + 'px';
    card.style.position = 'fixed';
    
    card.innerHTML = '<button class="user-card-close" onclick="document.querySelectorAll(\'.discord-user-card-backdrop, .discord-user-card\').forEach(el => el.remove())">Ã—</button><div class="user-card-banner"></div><div class="user-card-body"><div class="user-card-loading"><div class="spinner"></div><span>Loading...</span></div></div>';
    
    document.body.appendChild(backdrop);
    document.body.appendChild(card);
    
    ajax("/u/" + username + ".json").then(data => {
      const user = data.user;
      const avatar = (user.avatar_template.startsWith('/') ? window.location.origin : '') + user.avatar_template.replace('{size}', '256');
      
      const body = card.querySelector('.user-card-body');
      body.innerHTML = '<div class="user-card-avatar"><img src="' + avatar + '"><div class="status-badge"></div></div><div class="user-info"><h2 class="display-name">' + (user.name || user.username) + '</h2><p class="username">@' + user.username + '</p>' + (user.title ? '<span class="title-badge">' + user.title + '</span>' : '') + '</div><div class="user-body-content"><div><div class="stats-section"><div class="section-title">Stats</div><div class="stats-grid"><div class="stat-box"><span class="stat-value">' + (user.post_count || 0) + '</span><span class="stat-label">Posts</span></div><div class="stat-box"><span class="stat-value">' + (user.like_count || 0) + '</span><span class="stat-label">Likes</span></div><div class="stat-box"><span class="stat-value">' + (user.solved_count || 0) + '</span><span class="stat-label">Solutions</span></div></div></div></div><div>' + (user.badge_count > 0 ? '<div class="badges-section"><div class="section-title">Badges</div><div class="badges-list"><div class="badge-chip"><span>ğŸ…</span><span>' + user.badge_count + ' Badge' + (user.badge_count !== 1 ? 's' : '') + '</span></div></div></div>' : '') + (user.groups && user.groups.length > 0 ? '<div class="groups-section"><div class="section-title">Groups</div><div class="groups-list">' + user.groups.slice(0, 4).map(g => '<a href="/g/' + g.name + '" class="group-chip">' + (g.display_name || g.name) + '</a>').join('') + '</div></div>' : '') + '</div></div><div class="user-actions"><a href="/new-message?username=' + user.username + '&type=chat" class="btn btn-primary">ğŸ’¬ Chat</a><a href="/new-message?username=' + user.username + '" class="btn btn-secondary">âœ‰ï¸ Message</a><a href="/u/' + user.username + '" class="btn btn-secondary">ğŸ‘¤ Profile</a></div>';
    });
  }

  function closeUserCard() {
    document.querySelectorAll('.discord-user-card-backdrop, .discord-user-card').forEach(el => el.remove());
  }

  function getUserRole(user) {
    if (user.admin) return 'admin';
    if (user.moderator) return 'moderator';
    return 'tl' + (user.trust_level || 0);
  }

  function updateOnlineStatus() {
    ajax("/sideonline.json").then(data => {
      const onlineUsers = data.users || [];
      onlineUsernames = new Set(onlineUsers.map(u => u.username));
      
      const count = document.querySelector('.online-count');
      if (count) count.textContent = onlineUsernames.size;
      
      // Refresh the sidebar with updated online status
      createSidebar();
    }).catch(err => {
      console.error('[Discord Style Chat] Failed to fetch online users:', err);
    });
  }

  function createSidebar() {
    const existing = document.getElementById('discord-online-users-sidebar');
    if (existing) existing.remove();
    
    const sidebar = document.createElement('div');
    sidebar.id = 'discord-online-users-sidebar';
    sidebar.className = 'discord-sidebar';
    sidebar.style.cssText = 'position:fixed!important;top:60px!important;right:0!important;width:' + sidebarWidth + 'px!important;height:calc(100vh - 60px)!important;background:#2f3136!important;border-left:1px solid #202225!important;z-index:9999!important;overflow-y:auto!important;display:block!important;';
    sidebar.innerHTML = '<div class="discord-sidebar-header" style="padding:16px;border-bottom:1px solid #202225;"><h3 style="color:#8e9297;font-size:12px;font-weight:600;margin:0;">Users â€” <span class="online-count">0</span></h3></div><div class="discord-sidebar-users loading" style="padding:8px;"></div>';
    document.body.appendChild(sidebar);

    ajax("/directory_items.json", { data: { period: "all", order: "likes_received", asc: false } }).then(data => {
      const allUsers = data.directory_items || [];
      const container = document.querySelector('.discord-sidebar-users');
      const count = document.querySelector('.online-count');
      if (!container) return;
      container.classList.remove('loading');
      
      // Categorize users
      const admins = [];
      const moderators = [];
      const onlineTL3 = [];
      const onlineTL2 = [];
      const onlineTL1 = [];
      const onlineTL0 = [];
      const offline = [];
      
      allUsers.forEach(item => {
        const user = item.user;
        const isOnline = onlineUsernames.has(user.username);
        
        if (user.admin) {
          admins.push(user); // Always show admins
        } else if (user.moderator) {
          moderators.push(user); // Always show moderators
        } else if (isOnline) {
          // Only show non-staff if online
          const tl = user.trust_level || 0;
          if (tl === 4 || tl === 3) onlineTL3.push(user);
          else if (tl === 2) onlineTL2.push(user);
          else if (tl === 1) onlineTL1.push(user);
          else onlineTL0.push(user);
        } else {
          offline.push(user); // Offline non-staff
        }
      });
      
      let html = '';
      
      // Admins (always show)
      if (admins.length > 0) {
        html += '<div class="role-group"><div class="role-header" style="color:#e74c3c;font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;padding:12px 8px 4px 8px;">Administrators â€” ' + admins.length + '</div>';
        admins.forEach(u => html += renderUser(u));
        html += '</div>';
      }
      
      // Moderators (always show)
      if (moderators.length > 0) {
        html += '<div class="role-group"><div class="role-header" style="color:#f39c12;font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;padding:12px 8px 4px 8px;">Moderators â€” ' + moderators.length + '</div>';
        moderators.forEach(u => html += renderUser(u));
        html += '</div>';
      }
      
      // Online Trust Level 3 (only if online)
      if (onlineTL3.length > 0) {
        html += '<div class="role-group"><div class="role-header" style="color:#1abc9c;font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;padding:12px 8px 4px 8px;">Trust Level 3 â€” ' + onlineTL3.length + '</div>';
        onlineTL3.forEach(u => html += renderUser(u));
        html += '</div>';
      }
      
      // Online Trust Level 2 (only if online)
      if (onlineTL2.length > 0) {
        html += '<div class="role-group"><div class="role-header" style="color:#95a5a6;font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;padding:12px 8px 4px 8px;">Trust Level 2 â€” ' + onlineTL2.length + '</div>';
        onlineTL2.forEach(u => html += renderUser(u));
        html += '</div>';
      }
      
      // Online Trust Level 1 (only if online)
      if (onlineTL1.length > 0) {
        html += '<div class="role-group"><div class="role-header" style="color:#7f8c8d;font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;padding:12px 8px 4px 8px;">Trust Level 1 â€” ' + onlineTL1.length + '</div>';
        onlineTL1.forEach(u => html += renderUser(u));
        html += '</div>';
      }
      
      // Online Trust Level 0 (only if online)
      if (onlineTL0.length > 0) {
        html += '<div class="role-group"><div class="role-header" style="color:#5f6c6d;font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;padding:12px 8px 4px 8px;">Trust Level 0 â€” ' + onlineTL0.length + '</div>';
        onlineTL0.forEach(u => html += renderUser(u));
        html += '</div>';
      }
      
      // Offline (everyone offline except staff)
      if (offline.length > 0) {
        html += '<div class="role-group"><div class="role-header" style="color:#72767d;font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;padding:12px 8px 4px 8px;">Offline â€” ' + offline.length + '</div>';
        offline.forEach(u => html += renderUser(u));
        html += '</div>';
      }
      
      container.innerHTML = html;
      container.querySelectorAll('.discord-user-item').forEach(item => {
        item.onmouseenter = () => item.style.backgroundColor = '#3c3f45';
        item.onmouseleave = () => item.style.backgroundColor = 'transparent';
        item.onclick = (e) => { e.preventDefault(); e.stopPropagation(); showUserCard(item.dataset.username, e); };
      });
      
      count.textContent = onlineUsernames.size;
    });
  }
  
  function renderUser(user) {
    const avatar = (user.avatar_template.startsWith('/') ? window.location.origin : '') + user.avatar_template.replace('{size}', '96');
    const isOnline = onlineUsernames.has(user.username);
    const statusColor = isOnline ? '#43b581' : '#747f8d';
    const onlineClass = isOnline ? ' online' : '';
    
    return '<div class="discord-user-item' + onlineClass + '" data-username="' + user.username + '" style="display:flex;align-items:center;padding:8px;margin:2px 0;border-radius:4px;cursor:pointer;"><div style="width:32px;height:32px;margin-right:12px;position:relative;"><img src="' + avatar + '" style="width:100%;height:100%;border-radius:50%;"><div class="status-dot" style="position:absolute;bottom:-2px;right:-2px;width:12px;height:12px;background:' + statusColor + ';border:3px solid #2f3136;border-radius:50%;"></div></div><div style="flex:1;"><div style="color:#dcddde;font-size:14px;font-weight:500;">' + user.username + '</div></div></div>';
  }

  createSidebar();
  
  // Update online status every 30 seconds
  if (fetchTimer) clearInterval(fetchTimer);
  fetchTimer = setInterval(updateOnlineStatus, refreshInterval);
});
</script>